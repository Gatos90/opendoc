name: Release

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix
          echo "OPENDOC_VERSION=$VERSION" >> $GITHUB_ENV
          if [[ "$VERSION" == *-* ]]; then
            echo "OPENDOC_CHANNEL=preview" >> $GITHUB_ENV
          else
            echo "OPENDOC_CHANNEL=latest" >> $GITHUB_ENV
          fi

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Build binaries
        working-directory: packages/opendoc
        run: bun run ./script/build.ts

      - name: Publish to npm
        working-directory: packages/opendoc
        run: bun run ./script/publish.ts
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build SDK
        working-directory: packages/sdk/js
        run: |
          bun install
          bun run build

      - name: Publish SDK
        working-directory: packages/sdk/js/dist
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          npm publish --access public
        continue-on-error: true

      - name: Setup GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh -y
          fi

      - name: Upload release assets
        working-directory: packages/opendoc
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            ./dist/*.tar.gz \
            ./dist/*.zip \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew tap
        working-directory: packages/opendoc
        run: bun run ./script/publish-registries.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
